# ­ЪћД NixOS Rebuild Рђћ рЃљрЃЊрЃЏрЃўрЃюрЃўрЃАрЃбрЃарЃљрЃбрЃЮрЃарЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃЏрЃФрЃдрЃЋрЃљрЃюрЃћрЃџрЃЮ

## 0. рЃарЃљрЃА рЃЋрЃБрЃгрЃЮрЃЊрЃћрЃЉрЃЌ РђърЃарЃћрЃЉрЃўрЃџрЃЊрЃАРђю

**rebuild** рЃюрЃўрЃерЃюрЃљрЃЋрЃА:

* рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃўрЃА рЃерЃћрЃцрЃљрЃАрЃћрЃЉрЃљрЃА (evaluation)
* рЃљрЃ«рЃљрЃџрЃў system generation-рЃўрЃА рЃљрЃњрЃћрЃЉрЃљрЃА
* рЃЏрЃўрЃАрЃў рЃњрЃљрЃљрЃЦрЃбрЃўрЃБрЃарЃћрЃЉрЃљрЃА рЃљрЃю рЃЕрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃўрЃАрЃЌрЃЋрЃўрЃА рЃЏрЃЮрЃЏрЃќрЃљрЃЊрЃћрЃЉрЃљрЃА

рЃарЃћрЃЉрЃўрЃџрЃЊрЃў **рЃљрЃа рЃљрЃарЃўрЃА рЃБрЃЉрЃарЃљрЃџрЃЮрЃЊ install**.
рЃћрЃА рЃљрЃарЃўрЃА **рЃљрЃбрЃЮрЃЏрЃБрЃарЃў рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃЮрЃърЃћрЃарЃљрЃфрЃўрЃљ**, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃДрЃЮрЃЋрЃћрЃџрЃЌрЃЋрЃўрЃА рЃбрЃЮрЃЋрЃћрЃЉрЃА рЃБрЃЎрЃљрЃю рЃЊрЃљрЃАрЃљрЃЉрЃарЃБрЃюрЃћрЃЉрЃћрЃџ рЃЎрЃЋрЃљрЃџрЃА (generation).

---

## 1. рЃгрЃўрЃюрЃљрЃърЃўрЃарЃЮрЃЉрЃћрЃЉрЃў (рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃў рЃгрЃћрЃАрЃћрЃЉрЃў)

рЃарЃћрЃЉрЃўрЃџрЃЊрЃљрЃЏрЃЊрЃћ **рЃДрЃЮрЃЋрЃћрЃџрЃЌрЃЋрЃўрЃА рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃГрЃћрЃерЃЏрЃљрЃарЃўрЃбрЃў**:

1. рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ рЃљрЃарЃўрЃА **flake-based**
2. `flake.lock` рЃљрЃарЃАрЃћрЃЉрЃЮрЃЉрЃА
3. рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃћрЃЉрЃў рЃЊрЃљрЃЎрЃЮрЃЏрЃўрЃбрЃћрЃЉрЃБрЃџрЃўрЃљ (`git status` рЃАрЃБрЃцрЃЌрЃљрЃљ)
4. рЃерЃћрЃю рЃўрЃфрЃў **рЃарЃЮрЃЏрЃћрЃџ host-рЃА рЃљрЃерЃћрЃюрЃћрЃЉ**

рЃЌрЃБ рЃарЃЮрЃЏрЃћрЃџрЃўрЃЏрЃћ рЃърЃўрЃарЃЮрЃЉрЃљ рЃЊрЃљрЃарЃдрЃЋрЃћрЃБрЃџрЃўрЃљ Рєњ рЃарЃћрЃЉрЃўрЃџрЃЊрЃў **рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃБрЃџрЃљрЃЊ рЃљрЃарЃљрЃАрЃгрЃЮрЃарЃўрЃљ**.

---

## 2. рЃФрЃўрЃарЃўрЃЌрЃљрЃЊрЃў рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ Рђћ `nixos-rebuild`

### рЃАрЃљрЃЉрЃљрЃќрЃўрЃАрЃЮ рЃАрЃўрЃюрЃбрЃљрЃЦрЃАрЃў (flake-рЃўрЃЌ)

```bash
sudo nixos-rebuild switch --flake .#laptop
```

рЃћрЃА рЃљрЃарЃўрЃА **рЃАрЃбрЃљрЃюрЃЊрЃљрЃарЃбрЃБрЃџрЃў рЃљрЃЊрЃЏрЃўрЃюрЃўрЃАрЃбрЃарЃљрЃбрЃЮрЃарЃўрЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљ**.

### рЃарЃљрЃА рЃюрЃўрЃерЃюрЃљрЃЋрЃА рЃЌрЃўрЃЌрЃЮрЃћрЃБрЃџрЃў рЃюрЃљрЃгрЃўрЃџрЃў

| рЃюрЃљрЃгрЃўрЃџрЃў             | рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЉрЃљ                       |
| ------------------ | --------------------------------- |
| `sudo`             | рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃЊрЃЮрЃюрЃћрЃќрЃћ рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃљ          |
| `nixos-rebuild`    | NixOS system builder              |
| `switch`           | рЃљрЃљрЃерЃћрЃюрЃћ рЃЊрЃљ **рЃЏрЃДрЃўрЃАрЃўрЃћрЃарЃљрЃЊ рЃњрЃљрЃљрЃЦрЃбрЃўрЃБрЃарЃћ** |
| `--flake .#laptop` | flake root + рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў host      |

> Рџа№ИЈ `#laptop` рЃљрЃа рЃљрЃарЃўрЃА рЃЊрЃћрЃЎрЃЮрЃарЃљрЃфрЃўрЃљ Рђћ рЃћрЃА рЃљрЃарЃўрЃА **host identity**.

---

## 3. rebuild рЃарЃћрЃЪрЃўрЃЏрЃћрЃЉрЃў Рђћ рЃарЃЮрЃЊрЃўрЃА рЃарЃљрЃА рЃЋрЃўрЃДрЃћрЃюрЃћрЃЉрЃЌ

### 3.1 `switch` Рђћ рЃДрЃЮрЃЋрЃћрЃџрЃЊрЃдрЃўрЃБрЃарЃў рЃАрЃљрЃЏрЃБрЃерЃљрЃЮ

```bash
sudo nixos-rebuild switch --flake .#laptop
```

рЃўрЃДрЃћрЃюрЃћрЃЉ, рЃарЃЮрЃфрЃљ:

* рЃерЃћрЃфрЃЋрЃљрЃџрЃћ service
* рЃЊрЃљрЃљрЃЏрЃљрЃбрЃћ рЃърЃљрЃЎрЃћрЃбрЃў
* рЃерЃћрЃфрЃЋрЃљрЃџрЃћ system рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃў
* рЃЊрЃљрЃарЃгрЃЏрЃБрЃюрЃћрЃЉрЃБрЃџрЃў рЃ«рЃљрЃа рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃљрЃерЃў

**рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃљ:**

* рЃЦрЃЏрЃюрЃўрЃА рЃљрЃ«рЃљрЃџ generation-рЃА
* рЃЏрЃДрЃўрЃАрЃўрЃћрЃарЃљрЃЊ рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА рЃљрЃ«рЃљрЃџ рЃАрЃўрЃАрЃбрЃћрЃЏрЃљрЃќрЃћ
* рЃФрЃЋрЃћрЃџрЃў рЃарЃЕрЃћрЃЉрЃљ boot menu-рЃерЃў

---

### 3.2 `boot` Рђћ рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮ рЃарЃћрЃЪрЃўрЃЏрЃў

```bash
sudo nixos-rebuild boot --flake .#laptop
```

рЃўрЃДрЃћрЃюрЃћрЃЉ, рЃарЃЮрЃфрЃљ:

* рЃћрЃ«рЃћрЃЉрЃў bootloader-рЃА
* kernel-рЃА
* low-level рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃа рЃюрЃљрЃгрЃўрЃџрЃА
* **рЃљрЃа рЃњрЃўрЃюрЃЊрЃљ рЃЏрЃДрЃўрЃАрЃўрЃћрЃарЃў рЃљрЃЦрЃбрЃўрЃЋрЃљрЃфрЃўрЃљ**

**рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃљ:**

* рЃЦрЃЏрЃюрЃўрЃА generation-рЃА
* рЃњрЃљрЃљрЃЦрЃбрЃўрЃБрЃарЃЊрЃћрЃЉрЃљ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃерЃћрЃЏрЃЊрЃћрЃњ рЃЕрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљрЃќрЃћ

РъА№ИЈ **рЃърЃарЃЮрЃцрЃћрЃАрЃўрЃЮрЃюрЃљрЃџрЃўрЃА рЃљрЃарЃЕрЃћрЃЋрЃљрЃюрЃў рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџ рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃћрЃЉрЃќрЃћ**

---

### 3.3 `test` Рђћ рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌрЃў рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ

```bash
sudo nixos-rebuild test --flake .#laptop
```

рЃўрЃДрЃћрЃюрЃћрЃЉ, рЃарЃЮрЃфрЃљ:

* рЃњрЃўрЃюрЃЊрЃљ рЃюрЃљрЃ«рЃЮ РђърЃўрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃА рЃЌрЃБ рЃљрЃарЃљРђю
* рЃћрЃЦрЃАрЃърЃћрЃарЃўрЃЏрЃћрЃюрЃбрЃўрЃљ
* рЃљрЃа рЃњрЃўрЃюрЃЊрЃљ boot menu-рЃерЃў рЃЊрЃљрЃарЃЕрЃћрЃА

**рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃљ:**

* рЃљрЃДрЃћрЃюрЃћрЃЉрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃљрЃА рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌ
* reboot-рЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ рЃЦрЃарЃћрЃЉрЃљ

---

## 4. рЃарЃљ рЃ«рЃЊрЃћрЃЉрЃљ рЃарЃћрЃЉрЃўрЃџрЃЊрЃўрЃА рЃерЃўрЃњрЃюрЃўрЃЌ (рЃарЃћрЃљрЃџрЃБрЃарЃљрЃЊ)

рЃарЃћрЃЉрЃўрЃџрЃЊрЃў рЃњрЃљрЃЊрЃўрЃА рЃћрЃбрЃљрЃърЃћрЃЉрЃА:

1. **Evaluation**

   * Nix рЃЎрЃўрЃЌрЃ«рЃБрЃџрЃЮрЃЉрЃА flake graph-рЃА
   * рЃљрЃгрЃДрЃЮрЃЉрЃА dependency DAG-рЃА
2. **Build**

   * рЃўрЃЉрЃўрЃџрЃЊрЃћрЃЉрЃљ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃўрЃА, рЃарЃљрЃф рЃерЃћрЃўрЃфрЃЋрЃљрЃџрЃљ
3. **Activation**

   * systemd units
   * symlinks
   * profiles
4. **Generation creation**

   * `/nix/var/nix/profiles/system-XX-link`

рЃЌрЃБ evaluation рЃЋрЃћрЃа рЃњрЃљрЃўрЃљрЃарЃљ Рєњ **рЃљрЃарЃљрЃцрЃћрЃарЃў рЃќрЃўрЃљрЃюрЃЊрЃћрЃЉрЃљ**.

---

## 5. Generation-рЃћрЃЉрЃў Рђћ рЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃў рЃЊрЃљ рЃЏрЃљрЃарЃЌрЃЋрЃљ

### рЃљрЃарЃАрЃћрЃЉрЃБрЃџрЃў generation-рЃћрЃЉрЃўрЃА рЃюрЃљрЃ«рЃЋрЃљ

```bash
sudo nix-env -p /nix/var/nix/profiles/system --list-generations
```

рЃњрЃљрЃЏрЃЮрЃўрЃбрЃљрЃюрЃА:

```text
74 2025-12-01
75 2025-12-10
76 2025-12-20 (current)
```

---

### рЃФрЃЋрЃћрЃџрЃў generation-рЃћрЃЉрЃўрЃА рЃгрЃљрЃерЃџрЃљ (рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃЊ)

#### рЃЊрЃљрЃбрЃЮрЃЋрЃћ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЉрЃЮрЃџрЃЮ 3

```bash
sudo nix-env -p /nix/var/nix/profiles/system --delete-generations +3
```

­Ъћ╣ `+3` рЃюрЃўрЃерЃюрЃљрЃЋрЃА:

> РђърЃгрЃљрЃерЃљрЃџрЃћ рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў, рЃњрЃљрЃарЃЊрЃљ рЃЉрЃЮрЃџрЃЮ 3-рЃўрЃАрЃљРђю

Рџа№ИЈ **рЃћрЃА рЃљрЃа рЃерЃџрЃўрЃА рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћ system-рЃА**

---

### рЃарЃћрЃљрЃџрЃБрЃарЃў рЃњрЃљрЃгрЃЏрЃћрЃюрЃЊрЃљ (store)

```bash
sudo nix-collect-garbage -d
```

рЃљрЃю flake-рЃЌрЃљрЃю рЃерЃћрЃАрЃљрЃЉрЃљрЃЏрЃўрЃАрЃў:

```bash
sudo nix store gc
```

---

## 6. Rollback Рђћ рЃљрЃЋрЃљрЃарЃўрЃБрЃџрЃў рЃАрЃўрЃбрЃБрЃљрЃфрЃўрЃљ

### Boot menu-рЃЊрЃљрЃю

* рЃЕрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃўрЃАрЃљрЃА рЃўрЃарЃЕрЃћрЃЋ рЃФрЃЋрЃћрЃџ generation-рЃА
* рЃљрЃГрЃћрЃа `d` Рєњ рЃўрЃА рЃ«рЃЊрЃћрЃЉрЃљ default

рЃћрЃА рЃљрЃарЃўрЃА **рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃћрЃЉрЃўрЃА рЃФрЃўрЃарЃўрЃЌрЃљрЃЊрЃў рЃЏрЃћрЃЦрЃљрЃюрЃўрЃќрЃЏрЃў**.

---

## 7. рЃбрЃўрЃърЃБрЃарЃў рЃерЃћрЃфрЃЊрЃЮрЃЏрЃћрЃЉрЃў (рЃЊрЃљ рЃарЃљрЃбрЃЮрЃЏрЃљрЃљ рЃфрЃБрЃЊрЃў)

### РЮї rebuild рЃЊрЃљрЃБрЃЎрЃЮрЃЏрЃўрЃбрЃћрЃЉрЃћрЃџрЃў рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃўрЃЌ

* рЃЋрЃћрЃа рЃњрЃљрЃўрЃњрЃћрЃЉ, рЃарЃЮрЃЏрЃћрЃџрЃў commit рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА
* rollback рЃЎрЃљрЃарЃњрЃљрЃЋрЃА рЃљрЃќрЃарЃА

### РЮї `home-manager switch` system-рЃўрЃАрЃЌрЃЋрЃўрЃА

* рЃљрЃарЃдрЃЋрЃћрЃЋрЃА System/User рЃАрЃљрЃќрЃдрЃЋрЃарЃћрЃЉрЃА
* рЃўрЃгрЃЋрЃћрЃЋрЃА рЃљрЃарЃљрЃАрЃбрЃљрЃЉрЃўрЃџрЃБрЃарЃЮрЃЉрЃљрЃА

### РЮї channel-based rebuild

* рЃљрЃарЃдрЃЋрЃћрЃЋрЃА flake рЃЏрЃЮрЃЊрЃћрЃџрЃА
* рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ рЃ«рЃЊрЃћрЃЉрЃљ рЃљрЃарЃљрЃарЃћрЃърЃарЃЮрЃЊрЃБрЃфрЃўрЃарЃћрЃЉрЃљрЃЊрЃў

---

## 8. рЃАрЃгрЃЮрЃарЃў рЃАрЃљрЃЏрЃБрЃерЃљрЃЮ рЃфрЃўрЃЎрЃџрЃў (рЃЊрЃљрЃЏрЃљрЃ«рЃАрЃЮрЃЋрЃарЃћрЃЉрЃљ)

```text
edit
РєЊ
git commit
РєЊ
sudo nixos-rebuild switch --flake .#laptop
РєЊ
verify (services / logs / behavior)
```

рЃЌрЃБ рЃћрЃА рЃфрЃўрЃЎрЃџрЃў рЃўрЃарЃдрЃЋрЃћрЃЋрЃљ Рєњ **рЃерЃћрЃю рЃљрЃдрЃљрЃа рЃЏрЃљрЃарЃЌрЃљрЃЋ рЃАрЃўрЃАрЃбрЃћрЃЏрЃљрЃА, рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ рЃЏрЃљрЃарЃЌрЃљрЃЋрЃА рЃерЃћрЃю**.

---

## рЃЊрЃљрЃАрЃЎрЃЋрЃюрЃљ

NixOS rebuild:

* рЃљрЃа рЃљрЃарЃўрЃА РђърЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃљРђю
* рЃљрЃарЃўрЃА **рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃарЃўрЃбрЃБрЃљрЃџрЃў**
* рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃњрЃљрЃФрЃџрЃћрЃЋрЃА:

  * рЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃА
  * рЃњрЃљрЃЏрЃГрЃЋрЃўрЃарЃЋрЃљрЃџрЃЮрЃЉрЃљрЃА
  * рЃАрЃарЃБрЃџ rollback-рЃА


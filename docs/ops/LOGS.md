# ­ЪћЇ NixOS rebuild рЃџрЃЮрЃњрЃћрЃЉрЃўрЃА рЃЎрЃўрЃЌрЃ«рЃЋрЃљ

## 0. рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃърЃарЃўрЃюрЃфрЃўрЃърЃў

**rebuild рЃџрЃЮрЃњрЃћрЃЉрЃў рЃљрЃа рЃљрЃарЃўрЃА рЃћрЃарЃЌрЃў рЃџрЃЮрЃњрЃў.**
`nixos-rebuild` рЃљрЃарЃўрЃА **рЃЮрЃарЃЎрЃћрЃАрЃбрЃарЃљрЃбрЃЮрЃарЃў**, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃљрЃћрЃарЃЌрЃўрЃљрЃюрЃћрЃЉрЃА:

1. Nix evaluator-рЃА
2. Nix builder-рЃА
3. systemd activation-рЃА
4. bootloader update-рЃА

рЃерЃћрЃфрЃЊрЃЮрЃЏрЃўрЃА рЃњрЃљрЃАрЃљрЃњрЃћрЃЉрЃљрЃЊ рЃБрЃюрЃЊрЃљ рЃўрЃфрЃЮрЃЊрЃћ:

> **рЃарЃЮрЃЏрЃћрЃџ рЃцрЃљрЃќрЃљрЃерЃў рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ рЃърЃарЃЮрЃфрЃћрЃАрЃў**

---

## 1. `nixos-rebuild`-рЃўрЃА рЃърЃўрЃарЃЊрЃљрЃърЃўрЃарЃў output

рЃарЃћрЃЉрЃўрЃџрЃЊрЃўрЃА рЃЊрЃарЃЮрЃА рЃарЃљрЃф рЃбрЃћрЃарЃЏрЃўрЃюрЃљрЃџрЃерЃў рЃЕрЃљрЃюрЃА, рЃљрЃарЃўрЃА **рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЊрЃљ рЃДрЃЋрЃћрЃџрЃљрЃќрЃћ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў рЃџрЃЮрЃњрЃў**.

```bash
sudo nixos-rebuild switch --flake .#laptop
```

### рЃбрЃўрЃърЃБрЃарЃў рЃцрЃљрЃќрЃћрЃЉрЃў output-рЃерЃў

#### 1№ИЈРЃБ Evaluation

```text
evaluating the system configuration...
```

рЃљрЃЦ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ рЃюрЃўрЃерЃюрЃљрЃЋрЃА:

* рЃАрЃўрЃюрЃбрЃљрЃЦрЃАрЃА
* рЃљрЃарЃљрЃарЃАрЃћрЃЉрЃБрЃџ option-рЃА
* flake wiring рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљрЃА

­ЪЉЅ **рЃћрЃА рЃљрЃа рЃљрЃарЃўрЃА build рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ**

---

#### 2№ИЈРЃБ Build

```text
building the system configuration...
```

рЃљрЃЦ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ рЃюрЃўрЃерЃюрЃљрЃЋрЃА:

* рЃърЃљрЃЎрЃћрЃбрЃўрЃА build рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ
* hash mismatch
* sandbox / dependency рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ

­ЪЉЅ рЃћрЃА рЃљрЃарЃўрЃА **рЃюрЃљрЃЏрЃЊрЃЋрЃўрЃџрЃў build failure**

---

#### 3№ИЈРЃБ Activation

```text
activating the configuration...
```

рЃљрЃЦ рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ рЃюрЃўрЃерЃюрЃљрЃЋрЃА:

* systemd service рЃЋрЃћрЃа рЃњрЃљрЃћрЃерЃЋрЃљ
* activation script рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ
* runtime рЃЎрЃЮрЃюрЃцрЃџрЃўрЃЦрЃбрЃў

­ЪЉЅ build рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃўрЃљ, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ рЃљрЃа рЃўрЃЊрЃњрЃљ рЃАрЃгрЃЮрЃарЃљрЃЊ

---

## 2. рЃЊрЃћрЃбрЃљрЃџрЃБрЃарЃў рЃџрЃЮрЃњрЃў Рђћ `--show-trace`

рЃЌрЃБ evaluation error рЃњрЃљрЃЦрЃЋрЃА:

```bash
sudo nixos-rebuild switch \
  --flake .#laptop \
  --show-trace
```

### рЃарЃљрЃА рЃњрЃљрЃФрЃџрЃћрЃЋрЃА `--show-trace`

* рЃАрЃарЃБрЃџрЃў call stack
* рЃќрЃБрЃАрЃбрЃў `.nix` рЃцрЃљрЃўрЃџрЃў
* option-рЃўрЃА рЃгрЃљрЃарЃЏрЃЮрЃерЃЮрЃЉрЃљ

РЮЌ **рЃћрЃА рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ рЃАрЃћрЃарЃўрЃЮрЃќрЃБрЃџ debug-рЃќрЃћ**

---

## 3. Build failure рЃџрЃЮрЃњрЃўрЃА рЃљрЃЏрЃЮрЃдрЃћрЃЉрЃљ

рЃЌрЃБ рЃ«рЃћрЃЊрЃљрЃЋ:

```text
error: builder for '/nix/store/...drv' failed
```

### 3.1 рЃюрЃљрЃ«рЃћ рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў build рЃџрЃЮрЃњрЃў

```bash
nix log /nix/store/XXXX.drv
```

рЃљрЃю рЃБрЃцрЃарЃЮ рЃърЃарЃљрЃЦрЃбрЃўрЃЎрЃБрЃџрЃў:

```bash
nix log $(nix-store -q --deriver /nix/store/FAILED-PATH)
```

рЃљрЃЦ рЃюрЃљрЃ«рЃљрЃЋ:

* compiler error
* missing dependency
* test failure

---

## 4. Activation рЃџрЃЮрЃњрЃћрЃЉрЃў Рђћ systemd

рЃарЃћрЃЉрЃўрЃџрЃЊрЃў рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃљ, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃарЃљрЃдрЃљрЃф **рЃљрЃа рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА**.

### 4.1 рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћ boot-рЃўрЃА рЃџрЃЮрЃњрЃћрЃЉрЃў

```bash
journalctl -b
```

### 4.2 рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў service

```bash
journalctl -u nginx.service
```

рЃљрЃю рЃЉрЃЮрЃџрЃЮ activation:

```bash
journalctl -b -0 -p err
```

­ЪЉЅ рЃљрЃЦ рЃўрЃЎрЃўрЃЌрЃ«рЃћрЃЉрЃљ **рЃарЃћрЃљрЃџрЃБрЃарЃў runtime рЃАрЃўрЃЏрЃљрЃарЃЌрЃџрЃћ**

---

## 5. рЃгрЃўрЃюрЃљ generation-рЃўрЃА activation рЃџрЃЮрЃњрЃўрЃА рЃюрЃљрЃ«рЃЋрЃљ

рЃФрЃљрЃџрЃўрЃљрЃю рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў admin-рЃбрЃарЃўрЃБрЃЎрЃў:

```bash
journalctl --list-boots
```

рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў:

```text
-1  2025-01-10
 0  2025-01-18
```

рЃФрЃЋрЃћрЃџрЃў generation-рЃўрЃА рЃџрЃЮрЃњрЃў:

```bash
journalctl -b -1
```

­ЪЉЅ рЃќрЃБрЃАрЃбрЃљрЃЊ рЃљрЃАрЃћ рЃўрЃЎрЃЋрЃџрЃћрЃЋ **рЃарЃљрЃбрЃЮрЃЏ рЃљрЃа рЃЕрЃљрЃўрЃбрЃЋрЃўрЃарЃЌрЃљ рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ**

---

## 6. rebuild-рЃўрЃА рЃњрЃљрЃерЃЋрЃћрЃЉрЃљ РђърЃ«рЃЏрЃљрЃБрЃарЃўрЃљрЃю рЃарЃћрЃЪрЃўрЃЏрЃерЃўРђю

рЃЌрЃБ рЃњрЃўрЃюрЃЊрЃљ рЃЏрЃљрЃЦрЃАрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃЊрЃћрЃбрЃљрЃџрЃў:

```bash
sudo nixos-rebuild switch \
  --flake .#laptop \
  --verbose \
  --show-trace
```

рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ debug-рЃќрЃћ Рђћ рЃДрЃЮрЃЋрЃћрЃџрЃЊрЃдрЃўрЃБрЃарЃљрЃЊ рЃљрЃарЃљ.

---

## 7. рЃДрЃЋрЃћрЃџрЃљрЃќрЃћ рЃ«рЃерЃўрЃарЃў рЃерЃћрЃфрЃЊрЃЮрЃЏрЃћрЃЉрЃўрЃА рЃЎрЃўрЃЌрЃ«рЃЋрЃљ

### РЮї `attribute 'xyz' missing`

рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЉрЃљ:

* рЃљрЃарЃљрЃАрЃгрЃЮрЃарЃў option
* рЃљрЃю рЃљрЃарЃљрЃАрЃгрЃЮрЃа scope-рЃерЃўрЃљ

рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃћрЃбрЃљ:

* рЃњрЃљрЃЊрЃљрЃљрЃЏрЃЮрЃгрЃЏрЃћ:

```bash
nixos-option services.xyz
```

---

### РЮї `The option Рђд does not exist`

рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЉрЃљ:

* рЃЋрЃћрЃарЃАрЃўрЃўрЃА mismatch
* рЃљрЃю legacy рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃљрЃфрЃўрЃљ

­ЪЉЅ **25.11+ рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃљрЃфрЃўрЃљ рЃњрЃљрЃЊрЃљрЃљрЃЏрЃЮрЃгрЃЏрЃћ**

---

### РЮї build succeeds, system broken

рЃюрЃўрЃерЃљрЃюрЃў:

* rebuild рЃњрЃљрЃўрЃљрЃарЃљ
* рЃЏрЃљрЃњрЃарЃљрЃЏ service рЃљрЃа рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА

рЃњрЃќрЃљ:

```bash
journalctl -b
systemctl status <service>
```

---

## 8. рЃЮрЃЦрЃарЃЮрЃА рЃгрЃћрЃАрЃў (рЃЊрЃљрЃўрЃЏрЃљрЃ«рЃАрЃЮрЃЋрЃарЃћ)

| рЃАрЃўрЃЏрЃърЃбрЃЮрЃЏрЃў         | рЃАрЃљрЃЊ рЃЎрЃўрЃЌрЃ«рЃБрЃџрЃЮрЃЉ                       |
| ---------------- | ---------------------------------- |
| рЃљрЃа рЃўрЃЉрЃўрЃџрЃЊрЃћрЃЉрЃљ      | `nixos-rebuild` output + `nix log` |
| рЃљрЃа рЃЕрЃљрЃўрЃбрЃЋрЃўрЃарЃЌрЃљ     | boot menu + `journalctl -b -1`     |
| service рЃЏрЃЎрЃЋрЃЊрЃљрЃарЃўрЃљ | `systemctl status`                 |
| рЃБрЃфрЃюрЃљрЃБрЃарЃў рЃЦрЃфрЃћрЃЋрЃљ    | activation + runtime logs          |

---

## рЃЊрЃљрЃАрЃЎрЃЋрЃюрЃљ

**рЃЎрЃљрЃарЃњрЃў NixOS рЃљрЃЊрЃЏрЃўрЃюрЃўрЃАрЃбрЃарЃљрЃбрЃЮрЃарЃў:**

* рЃљрЃа рЃБрЃДрЃБрЃарЃћрЃЉрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃћрЃарЃЌ рЃџрЃЮрЃњрЃА
* рЃўрЃфрЃўрЃА рЃцрЃљрЃќрЃћрЃЉрЃў
* рЃўрЃфрЃўрЃА рЃАрЃљрЃЊ рЃћрЃФрЃћрЃЉрЃЮрЃА рЃАрЃўрЃЏрЃљрЃарЃЌрЃџрЃћ


